<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Data Visualizer</title>
    <!-- 1. We load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. We load Plotly.js, our charting library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        /* A little custom style for the charts */
        .chart-container {
            border: 1px solid #374151; /* gray-700 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem; /* p-4 */
            background-color: #1F2937; /* gray-800 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Make Plotly's default background transparent to match our dark mode */
        .js-plotly-plot .plotly .bg {
            fill: transparent !important;
        }
        .js-plotly-plot .plotly .plot-container {
            background-color: transparent !important;
        }
        
        /* --- NEW STYLES FOR CHAT --- */
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #4F46E5; /* indigo-600 */
            color: white;
            align-self: flex-end; /* Aligns to the right */
        }
        .ai-message {
            background-color: #374151; /* gray-700 */
            color: #E5E7EB; /* gray-200 */
            align-self: flex-start; /* Aligns to the left */
        }
        .ai-typing {
            color: #9CA3AF; /* gray-400 */
            align-self: flex-start;
            font-style: italic;
        }
    </style>
</head>
<body class="h-full text-gray-200 font-sans">
    <div class="min-h-full flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="max-w-3xl w-full text-center">
            <h1 class="text-4xl font-bold tracking-tight text-white">AI Data Visualizer</h1>
            <p class="mt-4 text-lg text-gray-400">
                Upload your CSV file and our AI will automatically analyze it and build visualizations.
            </p>
        </div>

        <!-- Uploader -->
        <div class="mt-10 max-w-lg w-full">
            <div class="bg-gray-800 shadow-xl rounded-lg p-8">
                <!-- This <input> is hidden. We trigger it with the button. -->
                <input type="file" id="csvFileInput" class="hidden" accept=".csv">
                
                <!-- This is the button the user clicks -->
                <button 
                    id="uploadButton"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
                >
                    Upload Your CSV File
                </button>
                
                <p id="fileName" class="text-center mt-4 text-gray-400"></p>
            </div>
        </div>

        <!-- Loading Spinner (Hidden by default) -->
        <div id="loadingSpinner" class="hidden text-center my-10">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-500 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg text-gray-300 mt-2">AI is analyzing your data, generating insights, and building charts...</p>
        </div>
        
        <!-- Error Message Box (Hidden by default) -->
        <div id="errorMessage" class="hidden max-w-3xl w-full bg-red-800 border border-red-600 text-red-100 px-4 py-3 rounded-lg mt-8" role="alert">
            <strong class="font-bold">Analysis Failed:</strong>
            <span id="errorText" class="block sm:inline">Something went wrong.</span>
        </div>
        
        <!-- --- NEW: INSIGHTS SECTION (Hidden by default) --- -->
        <div id="insightsContainer" class="hidden max-w-7xl w-full mt-10">
            <h2 class="text-2xl font-semibold text-white">Top AI Insights</h2>
            <div id="insightsList" class="mt-4 p-4 rounded-lg bg-gray-800 border border-gray-700">
                <!-- Insights will be inserted here by JavaScript -->
            </div>
        </div>

        <!-- Dashboard / Chart Area -->
        <div 
            id="dashboard" 
            class="mt-10 max-w-7xl w-full grid grid-cols-1 lg:grid-cols-2 gap-8"
        >
            <!-- Charts will be dynamically inserted here by JavaScript -->
        </div>

        <!-- --- NEW: METRICS SECTION (Hidden by default) --- -->
        <div id="metricsContainer" class="hidden max-w-3xl w-full mt-10">
            <h2 class="text-2xl font-semibold text-white">Define Custom Metrics</h2>
            <p class="text-gray-400 mt-2">
                Help the AI understand your data. (e.g., `Profit Margin = (Profit / Sales) * 100`)
            </p>
            <textarea 
                id="metricsInput"
                rows="3"
                class="w-full mt-4 p-3 rounded-md bg-gray-800 border border-gray-700 text-gray-200 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="Profit Margin = Profit / Sales&#10;Average Order Value = Sales / Count of OrderID"
            ></textarea>
        </div>

        <!-- --- NEW: CHAT INTERFACE (Hidden by default) --- -->
        <div id="chatContainer" class="hidden max-w-3xl w-full mt-10">
            <h2 class="text-2xl font-semibold text-white">Chat With Your Data</h2>
            
            <!-- Message Log -->
            <div 
                id="messageLog" 
                class="w-full h-96 mt-4 p-4 rounded-lg bg-gray-800 border border-gray-700 overflow-y-auto flex flex-col space-y-4"
            >
                <!-- Chat messages will appear here -->
                <div class="ai-message">Hello! Your data is loaded and I'm ready to answer your questions.</div>
            </div>

            <!-- Chat Input -->
            <div class="mt-4 flex">
                <input 
                    type="text" 
                    id="chatInput"
                    class="flex-1 p-3 rounded-l-md bg-gray-700 border border-gray-600 text-gray-200 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Ask a question about your data..."
                >
                <button 
                    id="sendButton"
                    class="px-5 py-3 bg-indigo-600 text-white font-medium rounded-r-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                    Send
                </button>
            </div>
        </div>

    </div>

    <!-- 3. This is the "brain" of our webpage -->
    <script>
        // Get references to our HTML elements
        const uploadButton = document.getElementById('uploadButton');
        const csvFileInput = document.getElementById('csvFileInput');
        const fileNameDisplay = document.getElementById('fileName');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const dashboard = document.getElementById('dashboard');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        
        // --- NEW: Get references to chat & insights elements ---
        const insightsContainer = document.getElementById('insightsContainer');
        const insightsList = document.getElementById('insightsList');
        const metricsContainer = document.getElementById('metricsContainer');
        const metricsInput = document.getElementById('metricsInput');
        const chatContainer = document.getElementById('chatContainer');
        const messageLog = document.getElementById('messageLog');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');

        // --- NEW GLOBALS FOR MEMORY ---
        let chatHistory = []; 
        let currentFilepath = ""; // This will hold the path to the CSV
        let currentColumns = "";  // This will hold the column names
        let currentInsights = []; // This will hold the insights

        // --- Step A: Trigger the file input (Unchanged) ---
        uploadButton.addEventListener('click', () => {
            csvFileInput.click();
        });

        // --- Step B: Handle the file selection (Updated for history) ---
        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileNameDisplay.textContent = `File selected: ${file.name}`;
                // --- RESET ALL MEMORY ON NEW UPLOAD ---
                chatHistory = []; 
                currentFilepath = "";
                currentColumns = "";
                currentInsights = [];
                handleFileUpload(file);
            }
        });

        // --- Step C: Upload the file to our Python Server (Updated) ---
        async function handleFileUpload(file) {
            // Clear old charts and errors
            dashboard.innerHTML = '';
            insightsContainer.classList.add('hidden'); // <-- NEW
            insightsList.innerHTML = ''; // <-- NEW
            errorMessage.classList.add('hidden');
            metricsContainer.classList.add('hidden');
            chatContainer.classList.add('hidden');
            messageLog.innerHTML = '<div class="ai-message">Hello! Your data is loaded and I\'m ready to answer your questions.</div>';
            
            loadingSpinner.classList.remove('hidden');

            const formData = new FormData();
            formData.append('file', file);

            try {
                // --- CALL PYTHON SERVER ON PORT 5001 ---
                const response = await fetch('http://127.0.0.1:5001/api/upload', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json(); // Get the *full* response
                
                if (!response.ok || data.error) {
                    throw new Error(data.details || 'The server returned an error.');
                }
                
                loadingSpinner.classList.add('hidden');
                
                // --- NEW: SAVE FILE INFO TO BROWSER MEMORY ---
                currentFilepath = data.filepath;
                currentColumns = data.columns;
                currentInsights = data.insights;
                
                // 5. Draw the insights and charts
                drawInsights(currentInsights); // <-- NEW
                drawDashboard(data.charts);
                
                // --- NEW: Show the chat and metrics boxes! ---
                insightsContainer.classList.remove('hidden'); // <-- NEW
                metricsContainer.classList.remove('hidden');
                chatContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Upload failed:', error);
                loadingSpinner.classList.add('hidden');
                errorText.textContent = ` ${error.message}. Is your Python server (app.py) running on port 5001?`;
                errorMessage.classList.remove('hidden');
            }
        }

        // --- NEW: FUNCTION TO DRAW INSIGHTS ---
        function drawInsights(insights) {
            insightsList.innerHTML = ''; // Clear old insights
            const ul = document.createElement('ul');
            ul.className = 'list-disc list-inside space-y-2 text-gray-300';
            insights.forEach(insight => {
                const li = document.createElement('li');
                li.innerText = insight;
                ul.appendChild(li);
            });
            insightsList.appendChild(ul);
        }

        // --- Step D: Draw all the charts from the "recipe" list (Unchanged) ---
        function drawDashboard(recipes) {
            recipes.forEach((recipe, index) => {
                const chartCard = document.createElement('div');
                chartCard.className = 'chart-container';
                const chartDiv = document.createElement('div');
                chartDiv.id = `chart-${index}`;
                const title = document.createElement('h2');
                title.className = 'text-xl font-semibold text-white mb-2';
                title.textContent = recipe.title;
                const description = document.createElement('p');
                description.className = 'text-sm text-gray-400 mb-4';
                description.textContent = recipe.description;
                
                chartCard.appendChild(title);
                chartCard.appendChild(description);
                chartCard.appendChild(chartDiv);
                dashboard.appendChild(chartCard);
                
                drawChart(recipe, chartDiv.id);
            });
        }
        
        // --- Step E: The main Plotly drawing function (Unchanged) ---
        function drawChart(recipe, divId) {
            const chartData = recipe.chart_data;
            const xCol = recipe.x_column;
            const yCol = recipe.y_column;
            let plotlyData = [];
            
            const plotlyLayout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#E5E7EB' }, // gray-200
                xaxis: { gridcolor: '#374151' }, // gray-700
                yaxis: { gridcolor: '#374151' }, 
                margin: { l: 50, r: 25, b: 50, t: 25, pad: 4 }
            };

            const xValues = chartData.map(row => row[xCol]);
            const yValues = chartData.map(row => row[yCol]);
            
            switch (recipe.chart_type) {
                case "Bar Chart":
                    plotlyData.push({ type: 'bar', x: xValues, y: yValues, marker: { color: '#4F46E5' } });
                    break;
                case "Line Chart":
                    plotlyData.push({ type: 'scatter', mode: 'lines+markers', x: xValues, y: yValues, line: { color: '#10B981' } });
                    break;
                case "Pie Chart":
                    plotlyData.push({ type: 'pie', labels: xValues, values: yValues, hole: 0.3, automargin: true, textinfo: 'percent', textposition: 'inside' });
                    plotlyLayout.xaxis = { showgrid: false, zeroline: false, showticklabels: false };
                    plotlyLayout.yaxis = { showgrid: false, zeroline: false, showticklabels: false };
                    break;
                case "Scatter Plot":
                    plotlyData.push({ type: 'scatter', mode: 'markers', x: xValues, y: yValues, marker: { color: '#3B82F6', size: 8, opacity: 0.7 } });
                    plotlyLayout.xaxis.title = xCol;
                    plotlyLayout.yaxis.title = yCol;
                    break;
                case "Histogram":
                     plotlyData.push({ type: 'histogram', x: xValues, marker: { color: '#EC4899' } });
                     plotlyLayout.xaxis.title = xCol;
                     plotlyLayout.yaxis.title = "Count";
                    break;
            }
            Plotly.newPlot(divId, plotlyData, plotlyLayout, {responsive: true});
        }

        // --- STEP F: NEW CHAT FUNCTIONS ---

        // Listen for a "click" on the send button
        sendButton.addEventListener('click', handleChatMessage);
        
        // Listen for the "Enter" key in the input box
        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Stop the form from submitting
                handleChatMessage();
            }
        });

        // This function adds a new message to our chat log
        function addMessage(message, type) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${type}-message`; 
            
            // This is a simple trick to render newlines
            messageElement.innerText = message; 
            
            if (type === 'ai-typing') {
                messageElement.id = 'typing-indicator';
            }
            
            messageLog.appendChild(messageElement);
            
            messageLog.scrollTop = messageLog.scrollHeight;
            
            // --- NEW MEMORY STEP: Add message to history ---
            if (type !== 'ai-typing') {
                // Keep history concise (last 6 messages)
                chatHistory.push(`${type.toUpperCase()}: ${message}`);
                if (chatHistory.length > 6) {
                    chatHistory.shift(); 
                }
            }
        }

        // This function removes the "AI is thinking..." message
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                messageLog.removeChild(indicator);
            }
        }

        // This function runs when you send a chat message
        async function handleChatMessage() {
            const question = chatInput.value.trim();
            // --- NEW: Safely encode the metrics text ---
            const metrics = encodeURIComponent(metricsInput.value.trim()); 

            if (!question) {
                return; 
            }
            
            // --- NEW MEMORY CHECK ---
            if (!currentFilepath) {
                addMessage("I'm sorry, I can't answer questions. Please upload a CSV file first.", "ai");
                return;
            }

            // 1. Add the user's message to the log
            addMessage(question, 'user');
            chatInput.value = ''; 

            // 2. Show the "typing" message
            addMessage('AI is thinking...', 'ai-typing');
            
            // 3. Prepare the data to send to the server
            const payload = {
                question: question,
                metrics: metrics, 
                history: chatHistory.join('\n'),
                // --- NEW: Send the file memory! ---
                filepath: currentFilepath,
                columns: currentColumns
            };

            try {
                // 4. Call our /api/chat endpoint on PORT 5001
                const response = await fetch('http://127.0.0.1:5001/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();
                
                // 5. Remove the "typing" message
                removeTypingIndicator();

                if (!response.ok || data.error) {
                    throw new Error(data.answer || 'An unknown error occurred.');
                }
                
                // 6. Add the AI's real answer
                addMessage(data.answer, 'ai');

            } catch (error) {
                console.error('Chat failed:', error);
                removeTypingIndicator();
                addMessage(`I'm sorry, I had trouble connecting. ${error.message}. Check your server logs for the AI's Python error.`, 'ai');
            }
        }

    </script>
</body>
</html>